<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Speech Compression Quality Test (MOS)</title>

  <style>
    :root {
      --primary-color: #2c3e50;
      --accent-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #c0392b;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: #333;
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 20px 40px 20px;
      line-height: 1.6;
    }

    /* Progress Bar */
    .progress-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 8px; background-color: #ddd; z-index: 2000;
    }
    .progress-bar {
      height: 100%; background-color: var(--danger-color); width: 0%; transition: width 0.25s ease, background-color 0.25s ease;
    }

    .progress-text {
      position: fixed; top: 10px; right: 20px; background: rgba(0,0,0,0.78); color: white;
      padding: 6px 10px; border-radius: 16px; font-size: 0.82em; z-index: 2001;
      user-select: none;
    }

    .progress-panel{
      position: fixed;
      top: 10px;
      left: 20px;
      background: rgba(255,255,255,0.92);
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.85em;
      z-index: 2001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      user-select: none;
    }

    h1 { text-align: center; color: var(--primary-color); margin-bottom: 5px; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-weight: 500; }

    .info-box {
      background: var(--card-bg); padding: 25px; border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px;
      border-left: 5px solid var(--accent-color);
    }
    .info-box p { margin-bottom: 15px; text-align: justify; }
    .info-box ul { padding-left: 20px; }
    .info-box li { margin-bottom: 8px; text-align: justify; }

    .calibration-box {
      background: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .calibration-box p { text-align: justify; }

    /* Sticky Header for Mobile/Desktop Table Guide */
    .sticky-guide {
      /* position: sticky; top: 0; z-index: 1000; Remove comment if you want it sticky */
      background: rgba(255,255,255,0.96);
      border: 1px solid #eaeaea;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      margin: 10px 0 18px 0;
      backdrop-filter: blur(6px);
    }
    .sticky-guide .row {
      display: grid;
      grid-template-columns: 10% 25% 1fr;
      gap: 12px;
      align-items: center;
      font-weight: 700;
      color: var(--primary-color);
    }
    .sticky-guide .cell {
      font-size: 0.95em;
      line-height: 1.1;
    }

    .rating-guide-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      font-size: 0.95em;
    }
    .rating-guide-table th {
      background: var(--primary-color);
      color: #fff;
      padding: 12px;
      text-align: left;
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    .rating-guide-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      text-align: left;
    }
    .rating-guide-table tr:last-child td { border-bottom: none; }

    .score-badge {
      display: inline-block; width: 32px; height: 32px; line-height: 32px;
      text-align: center; border-radius: 50%; color: white; font-weight: bold; font-size: 1.1em;
    }
    .score-5 { background-color: #27ae60; }
    .score-4 { background-color: #88cd38; }
    .score-3 { background-color: #f39c12; }
    .score-2 { background-color: #e67e22; }
    .score-1 { background-color: #c0392b; }

    .sample-card {
      background: var(--card-bg); padding: 25px; margin-bottom: 25px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s ease; border: 1px solid transparent;
    }
    .sample-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }

    .sample-header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
    }
    .sample-title { font-weight: bold; font-size: 1.1em; color: #444; }

    audio { width: 100%; margin-bottom: 20px; outline: none; height: 40px; }
    
    .form-row { display: grid; grid-template-columns: 1fr; gap: 20px; } /* Changed to single column since name is removed */
    .form-group label { font-weight: bold; display: block; margin-bottom: 8px; color: #2c3e50; }
    input[type="text"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

    .rating-container {
      background: #fafafa; padding: 15px; border-radius: 10px; text-align: center;
      border: 1px solid #eee; transition: all 0.3s;
    }
    .rating-container.locked {
      opacity: 0.5; pointer-events: none; background: #f0f0f0;
    }
    .rating-container.locked::after {
      content: "üîí Please listen first";
      display: block; font-size: 0.8em; color: var(--danger-color); margin-top: 10px; font-weight: bold;
    }
    .rating-group { display: flex; justify-content: space-between; gap: 5px; flex-wrap: wrap; }
    .rating-label {
      cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center;
      padding: 10px 5px; border-radius: 8px; transition: background 0.2s; min-width: 60px;
    }
    .rating-label:hover { background-color: #e8f4fd; }
    .rating-label input { margin-bottom: 8px; transform: scale(1.4); accent-color: var(--accent-color); cursor: pointer; }
    .rating-val { font-weight: bold; font-size: 1.1em; color: var(--primary-color); }
    .rating-desc { font-size: 0.75em; color: #666; line-height: 1.2; margin-top: 4px; }

    .step-card { display: none; }
    .step-card.active { display: block; }
    .step-card { scroll-margin-top: 80px; }

    .nav-row{
      display:flex;
      gap:12px;
      margin-top: 10px;
    }
    .nav-row button{
      flex:1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1.05em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s;
    }
    #next-btn{
      background-color: var(--accent-color);
      color: #fff;
    }
    #next-btn:hover{ background-color:#2980b9; transform: translateY(-1px); }
    #next-btn:disabled{
      background-color: #95a5a6;
      cursor:not-allowed;
      transform:none;
    }

    button#submit-btn {
      width: 100%;
      padding: 18px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 12px;
    }
    button#submit-btn:hover { background-color: #2980b9; transform: translateY(-2px); }
    button:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; }

    .loading { text-align: center; color: #7f8c8d; font-style: italic; padding: 40px; }

    .footer { text-align: center; font-size: 0.95em; color: #777; margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; }

    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .rating-guide-table th, .rating-guide-table td { padding: 10px 5px; font-size: 0.85em; }
      .progress-panel{ display:none; }
      .nav-row{ flex-direction: column; }
      .nav-row button{ width: 100%; }
      .sticky-guide .row { grid-template-columns: 18% 32% 1fr; }
    }
  </style>
</head>

<body>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="progress-panel" id="progressPanel">
    <strong>Progress:</strong> <span id="progressLabel">0 / 0</span>
  </div>
  <div class="progress-text" id="progressText">0 / 0 (0%)</div>

  <h1>Speech Compression Quality Test</h1>
  <p class="subtitle">Subjective Evaluation (MOS Test)</p>

  <div class="info-box">
    <h3>üìÑ Aim of the Study</h3>
    <p>
      This study is conducted to determine the perceptual performance of a developed speech compression method.
      You are expected to listen carefully to the presented audio samples and rate the quality of the sound you hear according to the specified criteria.
      Thank you for your contributions.
    </p>

    <h3>üéß Test Instructions</h3>
    <ul>
      <li>
        Please use <strong>headphones</strong> in a quiet environment.
      </li>
      <li>
        <strong>Important:</strong> You must play the audio first to enable the rating buttons.
      </li>
      <li>
        After listening and rating, proceed using the <strong>Next</strong> button.
      </li>
    </ul>
  </div>

  <div class="calibration-box">
    <h3>üîä Volume Adjustment (Calibration)</h3>
    <p>
      Please listen to the sample audio below and adjust your headphone/speaker volume to a <strong>comfortable and clear level</strong>.
      It is recommended not to change this level during the test.
    </p>

    <div style="text-align: center;">
      <audio controls src="audio/sample_02_original_1.wav" style="max-width: 400px;"></audio>
    </div>
  </div>


  <div class="sticky-guide" aria-label="Rating guide header">
    <div class="row">
      <div class="cell">Score</div>
      <div class="cell">Category</div>
      <div class="cell">Description & Conditions</div>
    </div>
  </div>


  <table class="rating-guide-table">
    <thead>
      <tr>
        <th style="width: 10%;">Score</th>
        <th style="width: 25%;">Category</th>
        <th>Description & Conditions</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><span class="score-badge score-5">5</span></td>
        <td><strong>Excellent</strong></td>
        <td>Very high speech intelligibility. Imperfections are non-existent or imperceptible.</td>
      </tr>

      <tr>
        <td><span class="score-badge score-4">4</span></td>
        <td><strong>Good</strong></td>
        <td>Minor imperfections may be audible, but they do not significantly affect the overall quality. Speech is easily followed.</td>
      </tr>

      <tr>
        <td><span class="score-badge score-3">3</span></td>
        <td><strong>Fair</strong></td>
        <td>Imperfections are noticeable. Quality is moderate, yet speech remains intelligible.</td>
      </tr>

      <tr>
        <td><span class="score-badge score-2">2</span></td>
        <td><strong>Poor</strong></td>
        <td>Quality is clearly low. Listening requires effort due to artifacts/noise.</td>
      </tr>

      <tr>
        <td><span class="score-badge score-1">1</span></td>
        <td><strong>Bad</strong></td>
        <td>Unacceptable quality. Speech is frequently unintelligible or severely annoying.</td>
      </tr>
    </tbody>
  </table>

  <form id="mos-form" novalidate>
    <input type="hidden" name="Sure_Saniye" id="durationInput">
    <input type="hidden" name="Katilimci_Ismi" value="Anonymous">

    <div class="sample-card">
      <div class="sample-header">
        <span class="sample-title">Participant Info (Required)</span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Listening Equipment:</label>
          <select name="Kulaklik_Tipi">
            <option value="Kablolu_Kulaklik">Wired Headphones</option>
            <option value="Bluetooth_Kulaklik">Bluetooth Headphones</option>
            <option value="Hoparlor">Speaker</option>
            <option value="Diger">Other</option>
          </select>
        </div>
      </div>
    </div>

    <div id="audio-container" class="loading">
      Preparing audio files...
    </div>

    <div class="nav-row">
      <button type="button" id="next-btn" disabled>
        Next Sample
      </button>
    </div>

    <button type="submit" id="submit-btn" style="display:none;" disabled>
      Complete Test and Submit
    </button>
  </form>

  <div class="footer">
    <p>
      ¬©  <br>
      (Data will be used anonymously for scientific purposes only.)
    </p>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbys0EXNGfyYc7OT3w8-DBDazw9CyPiQjRFCv2i-u-jHppF0aANUx5TQaYxkQ5KMUDwv/exec';

    const indexler = ['01', '02', '05', '09', '13', '14', '16', '18', '20', '22', '26', '28', '29', '50', '53', '70', '75', '82', '84', '95', '98'];
    const varyasyonlar = ["original_1", "recon_0_8", "recon_1_6", "recon_3_2", "recon_4"];

    const orijinalKalsin = new Set(["01", "02", "09"]);

    const anchorHavuzu = ["anchor_1", "anchor_2"];

    const startTime = Date.now();
    let oynatmaListesi = [];

    // Create playlist
    indexler.forEach(idx => {
      varyasyonlar.forEach(tur => {
        if (tur === "original_1" && !orijinalKalsin.has(idx)) return;

        oynatmaListesi.push({
          dosyaYolu: `audio/sample_${idx}_${tur}.wav`,
          sutunAdi: `sample_${idx}_${tur}`,
          benzersizID: `box_${idx}_${tur}`
        });
      });
    });

    
    function pickRandomDistinct(arr, k) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.slice(0, Math.min(k, a.length));
    }

    const secilenAnchorlar = pickRandomDistinct(anchorHavuzu, 2);
    secilenAnchorlar.forEach(a => {
      oynatmaListesi.push({
        dosyaYolu: `audio/${a}.wav`,
        sutunAdi: a,
        benzersizID: `box_${a}`
      });
    });

    
    function karistir(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

   
    oynatmaListesi = karistir(oynatmaListesi);

    
    oynatmaListesi.push({
      dosyaYolu: `audio/anchor_1.wav`,
      sutunAdi: `anchor_1_repeat`,
      benzersizID: `box_anchor_1_repeat`
    });

    const container = document.getElementById('audio-container');
    container.innerHTML = "";
    container.classList.remove("loading");

    
    const totalSteps = oynatmaListesi.length;
    let currentStep = 0;

    
    const rated = Array(totalSteps).fill(false);

    
    oynatmaListesi.forEach((item, index) => {
      const htmlContent = `
        <div class="sample-card step-card" data-step="${index}">
          <div class="sample-header">
            <span class="sample-title">
              Audio Sample #${index + 1}
            </span>
            <span style="font-weight:normal; font-size:0.8em; color:#999;">${index + 1} / ${totalSteps}</span>
          </div>

          <audio controls controlsList="nodownload" preload="none"
                 src="${item.dosyaYolu}"
                 onplay="unlockRating('${item.benzersizID}')">
          </audio>

          <div id="${item.benzersizID}" class="rating-container locked">
            <span class="rating-title">Your Quality Score:</span>

            <div class="rating-group">
              <label class="rating-label">
                <input type="radio" name="${item.sutunAdi}" value="1" required disabled onchange="onRate(${index})">
                <span class="rating-val">1</span>
                <span class="rating-desc">Bad</span>
              </label>
              <label class="rating-label">
                <input type="radio" name="${item.sutunAdi}" value="2" disabled onchange="onRate(${index})">
                <span class="rating-val">2</span>
                <span class="rating-desc">Poor</span>
              </label>
              <label class="rating-label">
                <input type="radio" name="${item.sutunAdi}" value="3" disabled onchange="onRate(${index})">
                <span class="rating-val">3</span>
                <span class="rating-desc">Fair</span>
              </label>
              <label class="rating-label">
                <input type="radio" name="${item.sutunAdi}" value="4" disabled onchange="onRate(${index})">
                <span class="rating-val">4</span>
                <span class="rating-desc">Good</span>
              </label>
              <label class="rating-label">
                <input type="radio" name="${item.sutunAdi}" value="5" disabled onchange="onRate(${index})">
                <span class="rating-val">5</span>
                <span class="rating-desc">Excellent</span>
              </label>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", htmlContent);
    });

    const stepCards = Array.from(document.querySelectorAll('.step-card'));
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');

    function pauseAllAudios() {
      document.querySelectorAll('audio').forEach(a => {
        try { a.pause(); } catch(e) {}
      });
    }

    function showStep(stepIndex, doScroll = true) {
      stepCards.forEach(c => c.classList.remove('active'));
      const card = stepCards[stepIndex];
      if (card) card.classList.add('active');

      pauseAllAudios();
      updateNavButtons();

      if (doScroll && card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function updateNavButtons() {
      const canGoNext = rated[currentStep] === true;
      const isLast = currentStep === (totalSteps - 1);

      if (!isLast) {
        nextBtn.style.display = "inline-block";
        nextBtn.disabled = !canGoNext;
        submitBtn.style.display = "none";
      } else {
        nextBtn.style.display = "none";
        submitBtn.style.display = "block";
        submitBtn.disabled = !canGoNext;
      }
    }

    
    window.unlockRating = function(elementId) {
      const c = document.getElementById(elementId);
      if (c.classList.contains('locked')) {
        c.classList.remove('locked');
        c.querySelectorAll('input').forEach(input => input.disabled = false);
      }
      updateNavButtons();
    };

    
    window.onRate = function(stepIndex) {
      rated[stepIndex] = true;
      updateProgress();
      updateNavButtons();
    };

  
    window.updateProgress = function() {
      const total = totalSteps;
      const answered = document.querySelectorAll('input[type="radio"]:checked').length;
      const percentage = Math.round((answered / total) * 100);

      const bar = document.getElementById('progressBar');
      const text = document.getElementById('progressText');
      const label = document.getElementById('progressLabel');

      bar.style.width = percentage + "%";
      text.innerText = `${answered} / ${total} (${percentage}%)`;
      if (label) label.innerText = `${answered} / ${total}`;

      if (percentage < 34) bar.style.backgroundColor = "var(--danger-color)";
      else if (percentage < 67) bar.style.backgroundColor = "var(--warning-color)";
      else bar.style.backgroundColor = "var(--success-color)";
    };

    // Navigation Click Event
    nextBtn.addEventListener('click', () => {
      if (!rated[currentStep]) {
        alert("Please rate this audio before continuing.");
        return;
      }
      if (currentStep < totalSteps - 1) {
        currentStep += 1;
        showStep(currentStep, true); 
      }
    });

    // Initialize
    updateProgress();
    showStep(0, false); 

    const form = document.getElementById('mos-form');

    form.addEventListener('submit', e => {
      e.preventDefault();

      // Name validation removed as requested

      const total = totalSteps;
      const answered = document.querySelectorAll('input[type="radio"]:checked').length;

      if (answered !== total) {
        alert(`Please rate all audios. (${answered}/${total})`);
        return;
      }

      const endTime = Date.now();
      const durationSeconds = Math.round((endTime - startTime) / 1000);
      document.getElementById('durationInput').value = durationSeconds;

      submitBtn.innerHTML = "Sending results to server...";
      submitBtn.style.backgroundColor = "#f39c12";
      submitBtn.disabled = true;

      const formData = new FormData(form);

      fetch(scriptURL, { method: 'POST', body: formData })
        .then(response => {
          alert("‚úÖ Completed!\nAll scores saved successfully.");
          submitBtn.innerHTML = "Submitted ‚úÖ";
          submitBtn.style.backgroundColor = "#27ae60";
        })
        .catch(error => {
          console.error('Error', error);
          alert("‚ùå Error occurred!");
          submitBtn.innerHTML = "Try Again";
          submitBtn.style.backgroundColor = "#c0392b";
          submitBtn.disabled = false;
        });
    });
  </script>
</body>
</html>
